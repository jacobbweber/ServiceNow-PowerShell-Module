name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PowerShell version
        run: Write-Host $PSVersionTable.PSVersion
        shell: pwsh

      - name: Install Pester
        run: |
          Install-Module -Name Pester -Force -Scope CurrentUser
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        shell: pwsh

      - name: Run PSScriptAnalyzer
        run: |
          Import-Module PSScriptAnalyzer
          $results = Invoke-ScriptAnalyzer -Path . -Recurse
          if (-not $results) { Write-Host 'No PSScriptAnalyzer issues found.'; exit 0 }
          $warnings = $results | Where-Object { $_.Severity -eq 'Warning' } | Select-Object -Property Severity,RuleName,ScriptName,Line
          $errors = $results | Where-Object { $_.Severity -eq 'Error' } | Select-Object -Property Severity,RuleName,ScriptName,Line
          if ($warnings) { Write-Host 'PSScriptAnalyzer Warnings:'; $warnings | Format-Table -AutoSize }
          if ($errors) { Write-Host 'PSScriptAnalyzer Errors:'; $errors | Format-Table -AutoSize; exit 1 }
        shell: pwsh

      - name: Run Pester tests
        run: |
          Invoke-Pester -Path tests -Output Detailed
        shell: pwsh

  publish:
    needs: lint-and-test
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PowerShell version
        run: Write-Host $PSVersionTable.PSVersion
        shell: pwsh

      - name: Publish to PowerShell Gallery (scaffold)
        run: |
          # This is a scaffolded publish step. To enable, set secret PSGalleryApiKey in the repo settings.
          if (-not $Env:PSGalleryApiKey) { Write-Host 'PSGalleryApiKey not set; skipping publish.'; exit 0 }
          Publish-Module -Path . -NuGetApiKey $Env:PSGalleryApiKey -Force
        shell: pwsh
